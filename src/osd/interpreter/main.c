#include "../osd-tube.h"
#include "wasm/load_wasm.h"
#include <memory.h>
#include <stdio.h>
#include <stdlib.h>

#define K64 0x10000

void import_wat(wasm_t *wat, buffer_t *bf);
uint32_t start_of_heap(wasm_t *wat);
void build_vm(wasm_t *wat, uint8_t *RAM, size_t RAM_size);
void run_vm(wasm_t *wat, uint8_t *RAM, size_t RAM_size, uint32_t heap_start);

unsigned char kernel_wasm[] = {
    0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00, 0x01, 0x0e, 0x03, 0x60, 0x00, 0x00, 0x60, 0x02, 0x7f, 0x7f, 0x01,
    0x7f, 0x60, 0x01, 0x7f, 0x00, 0x02, 0x14, 0x01, 0x03, 0x65, 0x6e, 0x76, 0x0c, 0x63, 0x61, 0x6c, 0x6c, 0x5f, 0x4f,
    0x53, 0x44, 0x5f, 0x41, 0x50, 0x49, 0x00, 0x01, 0x03, 0x04, 0x03, 0x00, 0x02, 0x00, 0x05, 0x03, 0x01, 0x00, 0x01,
    0x06, 0x21, 0x06, 0x7f, 0x00, 0x41, 0x00, 0x0b, 0x7f, 0x00, 0x41, 0x1f, 0x0b, 0x7f, 0x00, 0x41, 0x00, 0x0b, 0x7f,
    0x00, 0x41, 0xa0, 0xc0, 0x00, 0x0b, 0x7f, 0x00, 0x41, 0x00, 0x0b, 0x7f, 0x00, 0x41, 0x01, 0x0b, 0x07, 0x9b, 0x01,
    0x0a, 0x06, 0x6d, 0x65, 0x6d, 0x6f, 0x72, 0x79, 0x02, 0x00, 0x11, 0x5f, 0x5f, 0x77, 0x61, 0x73, 0x6d, 0x5f, 0x63,
    0x61, 0x6c, 0x6c, 0x5f, 0x63, 0x74, 0x6f, 0x72, 0x73, 0x00, 0x01, 0x18, 0x63, 0x61, 0x6c, 0x6c, 0x5f, 0x4f, 0x53,
    0x44, 0x5f, 0x41, 0x50, 0x49, 0x5f, 0x57, 0x72, 0x69, 0x74, 0x65, 0x53, 0x74, 0x72, 0x69, 0x6e, 0x67, 0x00, 0x02,
    0x06, 0x5f, 0x73, 0x74, 0x61, 0x72, 0x74, 0x00, 0x03, 0x0c, 0x5f, 0x5f, 0x64, 0x73, 0x6f, 0x5f, 0x68, 0x61, 0x6e,
    0x64, 0x6c, 0x65, 0x03, 0x00, 0x0a, 0x5f, 0x5f, 0x64, 0x61, 0x74, 0x61, 0x5f, 0x65, 0x6e, 0x64, 0x03, 0x01, 0x0d,
    0x5f, 0x5f, 0x67, 0x6c, 0x6f, 0x62, 0x61, 0x6c, 0x5f, 0x62, 0x61, 0x73, 0x65, 0x03, 0x02, 0x0b, 0x5f, 0x5f, 0x68,
    0x65, 0x61, 0x70, 0x5f, 0x62, 0x61, 0x73, 0x65, 0x03, 0x03, 0x0d, 0x5f, 0x5f, 0x6d, 0x65, 0x6d, 0x6f, 0x72, 0x79,
    0x5f, 0x62, 0x61, 0x73, 0x65, 0x03, 0x04, 0x0c, 0x5f, 0x5f, 0x74, 0x61, 0x62, 0x6c, 0x65, 0x5f, 0x62, 0x61, 0x73,
    0x65, 0x03, 0x05, 0x0a, 0x20, 0x03, 0x03, 0x00, 0x01, 0x0b, 0x09, 0x00, 0x41, 0x00, 0x20, 0x00, 0x10, 0x00, 0x1a,
    0x0b, 0x10, 0x00, 0x41, 0x00, 0x41, 0x10, 0x10, 0x00, 0x1a, 0x41, 0x00, 0x41, 0x00, 0x10, 0x00, 0x1a, 0x0b, 0x0b,
    0x24, 0x01, 0x00, 0x41, 0x00, 0x0b, 0x1e, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x20, 0x57, 0x6f, 0x72, 0x6c, 0x64, 0x20,
    0x32, 0x21, 0x0a, 0x00, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x20, 0x57, 0x6f, 0x72, 0x6c, 0x64, 0x21, 0x0a, 0x0a};
unsigned int kernel_wasm_len = 322;

int OSD_interpreter_main()
{
    char buf[256];

    // Work out file size and allocate a buffer, then read whole file. We are
    // only doing this for the kernel so have some control over it
    buffer_t bf;
    bf.len = kernel_wasm_len;
    bf.buffer = malloc(bf.len);
    bf.pos = 0;
    memcpy(bf.buffer, kernel_wasm, bf.len);

    // Check for header
    uint32_t magic = read_uint(&bf);
    if (magic != 0x6D736100)
    {
        fprintf(stderr, "Unknown WASM magic number\n");
        exit(1);
    }
    uint32_t version = read_uint(&bf);
    if (version != 1)
    {
        fprintf(stderr, "Unknown WASM version number\n");
        exit(1);
    }

    // Build our overall object
    wasm_t wat;
    memset(&wat, 0, sizeof(wasm_t));
    TubeWriteString("Importing WASM code\n");
    import_wat(&wat, &bf);

    // Work out allocation required for global data and the stack, this is the start of heap value
    uint32_t heap = start_of_heap(&wat);
    if (heap == 0)
    {
        fprintf(stderr, "Unable to figure out start of heap space");
        exit(1);
    }

    section_memory_t *memory = &wat.section_memories[0];
    size_t data_space_needed = wat.section_memories[0].min * K64;
    snprintf(buf, 256, "%d 64K page(s) of data space requested\r", wat.section_memories[0].min);
    TubeWriteString(buf);
    uint8_t *RAM = (uint8_t *)malloc(data_space_needed);
    TubeWriteString("Building VM\r");
    build_vm(&wat, RAM, data_space_needed);
    TubeWriteString("Running VM\r");
    run_vm(&wat, RAM, data_space_needed, heap);

    return 0;
}
